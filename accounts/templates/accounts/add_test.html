{% extends 'accounts/org_admin_base.html' %}
{% load static %}

{% block title %}Add Test{% endblock %}
{% block extra_css %} 
<link rel="stylesheet" href="{% static 'css/add_test.css' %}">
{% endblock %}
{% block content %}

<div class="container mt-5">
    <h2 class="mb-4">Create a New Test</h2>
    <form id="addTestForm" method="POST">
        {% csrf_token %}
        <div class="form-group">
            <label for="testName">Test Name</label>
            <input type="text" class="form-control" id="testName" name="title" required>
        </div>
        <div class="form-group">
            <label for="subject">Subject</label>
            <select class="form-control" id="subject" name="subject">
                <option value="">-- Select a Subject --</option>
                {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% empty %}
                    <option disabled>No subjects available</option>
                {% endfor %}
                <option value="new">Add New Subject</option>
            </select>

            <div class="form-group mt-2 d-none" id="newSubjectContainer">
                <label for="subjectName">New Subject Name</label>
                <input type="text" class="form-control" id="subjectName" name="subject_name" placeholder="Enter new subject name">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="totalQuestions">Total Questions</label>
                <input type="number" class="form-control" id="totalQuestions" name="total_questions" required>
            </div>
            <div class="form-group col-md-4">
                <label for="totalMarks">Total Marks</label>
                <input type="number" class="form-control" id="totalMarks" name="total_marks" required>
            </div>
            <div class="form-group col-md-4">
                <label for="totalTime">Total Time (minutes)</label>
                <input type="number" class="form-control" id="totalTime" name="total_time" required>
            </div>
        </div>

        <div class="form-group">
            <label for="testPassword">Test Password</label>
            <input type="text" class="form-control" id="testPassword" name="test_code" required>
        </div>

        <div class="form-group">
            <label>Test Questions</label>
            <div id="testQuestions" class="border rounded p-3">
                <button type="button" class="btn btn-outline-primary mt-2" id="addQuestionBtn">Add Questions</button>
            </div>
        </div>

        <button type="submit" class="btn btn-success">Create Test</button>
    </form>
</div>

<!-- Question Source Modal -->
<div class="modal fade" id="questionSourceModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose How to Add Questions</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <button class="btn btn-info btn-block" id="fromBankBtn">From Question Bank</button>
        <button class="btn btn-secondary btn-block" id="manualCreateBtn">Add Manually</button>
      </div>
    </div>
  </div>
</div>

<!-- Question Bank Modal -->
<div class="modal fade" id="questionBankModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Subject & Questions</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="subjectSelect">Subject</label>
          <select class="form-control" id="subjectSelect">
            {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
            {% empty %}
                <option disabled>No subjects available</option>
            {% endfor %}
          </select>
        </div>
        <div class="btn-group w-100 mb-3">
          <button class="btn btn-outline-primary w-50" id="randomSelectBtn">Randomly Select</button>
          <button class="btn btn-outline-dark w-50" id="manualPickBtn">Manually Pick</button>
        </div>

        <div id="randomQuestionInput" class="d-none">
          <label for="randomCount">How many questions?</label>
          <input type="number" class="form-control" id="randomCount" min="1">
          <button class="btn btn-success mt-2" id="randomAddBtn">Add Random Questions</button>
        </div>

        <div id="manualQuestionList" class="d-none">
          <!-- Questions with checkboxes will be dynamically injected here -->
        </div>
        <button class="btn btn-success d-none mt-2" id="addSelectedManualBtn">Add Selected Questions</button>
      </div>
    </div>
  </div>
</div>

<!-- Manual Question Creation Modal -->
<div class="modal fade" id="manualCreateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Question Manually</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <form id="manualQuestionForm">
          <div class="form-group">
            <label>Question Text</label>
            <textarea class="form-control" name="text" required></textarea>
          </div>
          <div class="form-group">
            <label>Option A</label>
            <input type="text" class="form-control" name="option1" required>
          </div>
          <div class="form-group">
            <label>Option B</label>
            <input type="text" class="form-control" name="option2" required>
          </div>
          <div class="form-group">
            <label>Option C</label>
            <input type="text" class="form-control" name="option3">
          </div>
          <div class="form-group">
            <label>Option D</label>
            <input type="text" class="form-control" name="option4">
          </div>
          <div class="form-group">
            <label>Correct Option</label>
            <select class="form-control" name="correct_option" required>
              <option value="">-- Select --</option>
              <option value="option1">Option A</option>
              <option value="option2">Option B</option>
              <option value="option3">Option C</option>
              <option value="option4">Option D</option>
            </select>
          </div>
          <div class="form-group">
            <label>Difficulty Level</label>
            <select class="form-control" name="difficulty" required>
              <option value="Easy">Easy</option>
              <option value="Medium">Medium</option>
              <option value="Hard">Hard</option>
            </select>
          </div>
          <input type="hidden" name="subject_id" id="manualSubjectId">
          <button type="submit" class="btn btn-success">Save Question</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% if messages %}
  <div class="messages">
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
        {{ message|safe }}
      </div>
    {% endfor %}
  </div>
{% endif %}

{% block extra_js %}
<script src="{% static 'js/add_test.js' %}"></script>
{% endblock %}
